# System Update Log: Post-Phase 25 (The "Response Text Error" Saga)

**Date**: February 13, 2026
**Focus**: Resolving the persistent `AttributeError`, `JSON Parsing Error`, and `Modality Error` loop that plagued the "Response Text" generation.

---

## üõë The Core Problem: "Response Text Error"
After Phase 25, the system stabilized, but a stubborn error persisted. The AI would often fail to generate a valid "Response Text", leading to:
1.  **Silence**: The AI "thinking" indefinitely.
2.  **Crash**: `AttributeError: 'NoneType' object has no attribute 'group'` (Regex failure).
3.  **Generic Error**: "I'm having trouble thinking right now."

This document details the **11-Phase Battle** (Phases 26-36) to trace and fix this issue, culminating in the **Final Resolution** achieved via the "New Chat" restructuring.

---

## üõ†Ô∏è Phase-by-Phase Debugging & Fixes

### Phase 26: The UI Sanitizer (Band-Aid Fix)
*   **Hypothesis**: The Brain was leaking raw JSON into the UI.
*   **Action**: Added `clean_ai_response` directly to `main_app.py` (the UI layer).
*   **Result**: ‚ùå Did not fix the root cause. The error was happening *inside* the Brain before it even reached the UI.

### Phase 27: Emergency De-JSON-ification (Attempted Root Cause Fix)
*   **Hypothesis**: The `gpt-4o-audio` model is bad at following JSON schemas. It was outputting broken JSON, causing the regex parser to crash (`AttributeError`).
*   **Action**:
    *   **Rewrote System Prompt**: Explicitly commanded the AI: *"Do NOT output JSON. Plain text only."*
    *   **Disabled Scoring**: Accepted that we couldn't get structured scores if we wanted stable text.
*   **Result**: ‚ùå The error persisted. Why? Because the **Model itself was crashing** before generating text.

### Phase 28: The `UnboundLocalError`
*   **Discovery**: The code crashed with `UnboundLocalError: local variable 'system_instruction' referenced before assignment`.
*   **Cause**: In "Recruiter Mode", the variable `system_instruction` was never initialized.
*   **Fix**: Added `system_instruction = RECRUITER_SYSTEM_PROMPT`.
*   **Result**: ‚úÖ Fixed one crash, but revealed the deeper "Modality" error.

### Phase 29: The Missing File (`ModuleNotFoundError`)
*   **Discovery**: The remote server crashed because `src/utils/sanitizer.py` was missing.
*   **Cause**: Git had failed to track the new file.
*   **Fix**: Created `src/utils/__init__.py` and forced a git add.
*   **Result**: ‚úÖ Server started, but AI still failed to reply.

### Phase 30 & 31: The Hidden "Modality" Error
*   **Discovery**: The "Response Text Error" was actually a mask for a **400 Bad Request** from Azure.
    *   **Error**: `Using a multimodal model requires modalities=['text', 'audio']`.
*   **Context**: We were treating `gpt-audio-preview` like a text model (`gpt-4`). It *refused* to answer unless we asked for Audio explicitly.
*   **Impact**: The `try/except` block caught this error, printed a generic message, and left `ai_text` undefined, causing the downstream `AttributeError`.

### Phase 32 & 33: Modality Fix & Fallback Strategy
*   **Action 1**: Updated `brain.py` to **retry** with `modalities=["text", "audio"]` if the first attempt failed.
*   **Action 2**: Implemented a **Fallback Loop**. If the Audio model failed, switch to `gpt-4o` (Standard).
*   **Result**: ‚ö†Ô∏è Better, but the system was *still* crashing with "Trouble Thinking".

### Phase 34: The "Trouble Thinking" Mystery (Logging Crash)
*   **Discovery**: The generic error "I'm having trouble thinking" was **NOT** coming from the AI.
*   **Root Cause**: When the code tried to *log* the Modality Error (`st.session_state.debug_logs += ...`), it crashed because **`debug_logs` did not exist**.
*   **Fix**: Initialized `st.session_state.debug_logs = ""` in `main_app.py`.
*   **Result**: ‚úÖ The real errors finally became visible.

### Phase 35 & 36: Startup Crashes (Initialization Order)
*   **Discovery**: `AttributeError: 'NoneType' object has no attribute 'expert_profile'`.
*   **Cause**: My "Hard Reload" logic (Phase 24) broke the startup sequence. `expert_profile` was being accessed before it was created.
*   **Fix**: Reordered initialization in `main_app.py`.

---

## ‚úÖ The Final Resolution (The "New Chat" Fix)

The persistent "Response Text Error" was fully conquered by the changes applied in the "New Chat". Here is the **Winning Formula**:

### 1. Proactive Modality Handling (No More Retries)
Instead of waiting for the `400 Bad Request` error and retrying (which was flaky), the new code checks the model name **before sending**:
```python
# If model name contains "audio", FORCE audio mode immediately
if "audio" in model_lower:
    req_params["modalities"] = ["text", "audio"]
```
**Why this worked**: It eliminated the error cycle entirely. The request is correct on the *first try*.

### 2. Complete Removal of JSON (Text Stability)
The code now treats the AI response as **pure text**:
```python
# No JSON parsing. No regex. No schema.
RECRUITER_INSTRUCTIONS = "... Plain text conversation only. Do NOT output JSON..."
```
**Why this worked**: It removed the fragility of the Regex parser. If the AI speaks, it works. No cryptic `AttributeError`.

### 3. Graceful Content Filter Handling
The new code explicitly catches Azure's safety blocks:
```python
if response.choices[0].finish_reason == 'content_filter':
    return {"text": "I cannot answer that because it triggered the safety filters..."}
```
**Why this worked**: Previously, a safety block would look like an empty response, triggering a crash. Now, it's handled as a valid (albeit refused) turn.

---

## Summary of the "Response Text Error"
The error was a multi-layered failure:
1.  **Layer 1 (Surface)**: `AttributeError` caused by Regex failing on bad JSON.
2.  **Layer 2 (Logic)**: `UnboundLocalError` preventing code execution.
3.  **Layer 3 (API)**: `400 Modality Error` because we treated an Audio model as text.
4.  **Layer 4 (Infrastructure)**: `KeyError` on Logging preventing us from seeing Layer 3.

**Status Now**: All layers are resolved. The system is stable.
